<!DOCTYPE html>
<html lang="zh" style="height: 100%">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title></title>
	<link rel="stylesheet" href="../static/css/emoji.css">
	<link rel="stylesheet" href="../static/layui/css/layui.css">
	<script src="../static/layui/layui.js"></script>
	<script src="../static/layui/lay/modules/element.js"></script>
	<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
	<script src="../static/js/emoji_jQuery.js"></script>
</head>
<body style="height: 100%">
	<div class="" style="height: 100%; width: 100%;">
		<div class="" style="height: calc(75% - 30px);">
			<!-- å¤§æ¡†ï¼ŒåŒ…æ‹¬è¾“å…¥æ˜µç§°ï¼Œé€‰æ‹©èŠå¤©å®¤ï¼Œè¿æ¥æŒ‰é’® -->
			<ul class="layui-nav" id="chatTittle" style="background-color: #9F9F9F;">
				<li class="layui-nav-item"><input type="text" style="border-radius: 5px; height: 25px;" id="userName" value="ä½ çš„æ˜µç§°"/></input></li>
				<li class="layui-nav-item">
					<a href="javascript:;" id="chooseRoomBtn">è¯·é€‰æ‹©</a>
					<dl class="layui-nav-child">
						<dd><a id="chooseRoomT">T-å¨±ä¹å®¤</a></dd>
						<dd><a id="chooseRoomI">I -æ•°ç å®¤</a></dd>
						<dd><a id="chooseRoomE">E-ç”µç«å®¤</a></dd>
						<dd><a id="chooseRoomZ">Z-æ‚è°ˆå®¤</a></dd>
					</dl>
				</li>
				<li class="layui-nav-item">
			<button type="button" id="clearBtn" class="layui-btn layui-btn-sm layui-btn-primary" style="float: right;">
				<i class="layui-icon">&#xe64c;</i>è¿æ¥
			</button>
				</li>
			</ul>
			<!-- èŠå¤©å±•ç¤ºåŒº -->
			<div id="chatShow" style="background-color: #eaeaea; height: 100%; overflow-y: auto;">
			</div>
		</div>
		<!-- èŠå¤©é”®å…¥åŒº -->
		<div style="background-color: #C2C2C2; height: 25%; overflow:hidden;">
			<div class="layui-layedit" style="height: 100%;">
				<div id="div_emoji" style="height: 30px;background-color: #C9C9C9;">
					<i id="personEmoji" class="layui-icon" style="margin: 5px; font-size: 20px;" title="äººç‰©">ğŸ˜€</i>
					<i id="goodsEmoji" class="layui-icon" style="margin: 5px; font-size: 20px;" title="ç‰©å“">ğŸ“¦</i>
					<i id="flagEmoji" class="layui-icon" style="margin: 5px; font-size: 20px;" title="æ ‡å¿—">ğŸ•</i>
					<i id="naturalEmoji" class="layui-icon" style="margin: 5px; font-size: 20px;" title="è‡ªç„¶">ğŸŒ¸</i>
					<i id="arrowEmoji" class="layui-icon" style="margin: 5px; font-size: 20px;" title="ç®­å¤´">ğŸ‘</i>
					<i id="animalEmoji" class="layui-icon" style="margin: 5px; font-size: 20px;" title="åŠ¨ç‰©">ğŸ´</i>
					<i id="sportsEmoji" class="layui-icon" style="margin: 5px; font-size: 20px;" title="è¿åŠ¨">â›·ï¸</i>
					<i id="foodEmoji" class="layui-icon" style="margin: 5px; font-size: 20px;" title="é£Ÿç‰©">ğŸ‹</i>
					<i id="buildingEmoji" class="layui-icon" style="margin: 5px; font-size: 20px;" title="å»ºç­‘">ğŸ¤</i>
					<i id="trafficEmoji" class="layui-icon" style="margin: 5px; font-size: 20px;" title="äº¤é€š">ğŸš</i>
				</div>
				<textarea id="content" style="width: 100%; height: 100%; font-size:15px; resize: none; box-sizing: border-box;"></textarea>
			</div>
		</div>
		<!-- åŠŸèƒ½åŒº -->
		<div style="background-color: #C2C2C2; height: 0%; width: 100%;">
			<button type="button" id="sendBtn" class="layui-btn layui-btn-sm layui-btn-primary" style="float: right;">
				<i class="layui-icon">&#x1005;</i>å‘é€
			</button>
			<button type="button" id="clearBtn" class="layui-btn layui-btn-sm layui-btn-primary" style="float: right;">
				<i class="layui-icon">&#x1006;</i>æ¸…ç©º
			</button>
	
		</div>
	</div>
</body>
<script>
	window.onload = function(){
		var seeWidth = document.body.clientWidth;
		var seeHeight = document.body.clientHeight;
	};
	var lvSDict = {
		0:'<i class="layui-icon" style="color: #FFECEC;">&#xe735;</i>',
		1:'<i class="layui-icon" style="color: #FFD2D2;">&#xe735;</i>',
		2:'<i class="layui-icon" style="color: #FFB5B5;">&#xe735;</i>',
		3:'<i class="layui-icon" style="color: #FF9797;">&#xe735;</i>',
		4:'<i class="layui-icon" style="color: #FF7575;">&#xe735;</i>',
		5:'<i class="layui-icon" style="color: #FF5151;">&#xe735;</i>',
		6:'<i class="layui-icon" style="color: #FF2D2D;">&#xe735;</i>',
		7:'<i class="layui-icon" style="color: #FF0000;">&#xe735;</i>',
		8:'<i class="layui-icon" style="color: #EA0000;">&#xe735;</i>',
		9:'<i class="layui-icon" style="color: #CE0000;">&#xe735;</i>',
		10:'<i class="layui-icon" style="color: #AE0000;">&#xe735;</i>'
	};
	// var LvUDict = {
	// 	0:'<i class="layui-icon" style="color: #FFECEC;">&#xe735;</i>',
	// 	1:'<i class="layui-icon" style="color: #FFD2D2;">&#xe735;</i>',
	// 	2:'<i class="layui-icon" style="color: #FFB5B5;">&#xe735;</i>',
	// 	3:'<i class="layui-icon" style="color: #FF9797;">&#xe735;</i>',
	// 	4:'<i class="layui-icon" style="color: #FF7575;">&#xe735;</i>',
	// 	5:'<i class="layui-icon" style="color: #FF5151;">&#xe735;</i>',
	// 	6:'<i class="layui-icon" style="color: #FF2D2D;">&#xe735;</i>',
	// 	7:'<i class="layui-icon" style="color: #FF0000;">&#xe735;</i>',
	// 	8:'<i class="layui-icon" style="color: #EA0000;">&#xe735;</i>',
	// 	9:'<i class="layui-icon" style="color: #CE0000;">&#xe735;</i>',
	// 	10:'<i class="layui-icon" style="color: #AE0000;">&#xe735;</i>'
	// };

	var div = document.getElementById("chatShow");
	var sTemplate1 = '<div><div><div style="background-color: #26a69a; border-radius:10px; margin: 2px 5px; padding: 8px; display:inline-block; *display:inline; *zoom:1;">'
	// var sTemplate2 = '<i class="layui-icon">&#xe735;</i>'
	// var sTemplate3 = 'ç”¨æˆ·åï¼š'
	var sTemplate4 = '</div></div><div style="background-color: #26a69a; border-radius:10px; margin: 10px 50px; padding: 8px; display:inline-block; *display:inline; *zoom:1;">'
	// var sTemplate5 = 'è¯´çš„è¯è¯´'
	var sTemplate6 = '</div></div>'
	
	var cTemplate1 = '<div style="overflow:hidden;"><div style="overflow:hidden;"><div style="background-color: #26a69a; border-radius:10px; margin: 2px 5px; padding: 8px; display:inline-block; *display:inline; *zoom:1; float: right;">'
	// var cTemplate2 = '<i class="layui-icon">&#xe735;</i>'
	// var cTemplate3 = 'è‡ªå·±ï¼š'
	var cTemplate4 = '</div></div><div style="background-color: #26a69a; border-radius:10px; margin: 10px 50px; padding: 8px; display:inline-block; *display:inline; *zoom:1; float: right;">'
	// var cTemplate5 = 'è‡ªå·±çš„è¯è‡ªå·±çš„è¯è‡ª'
	var cTemplate6 = '</div></div>'

	// æ¥æ”¶æ¶ˆæ¯ç±»
	// TODO è¿™é‡Œçš„ç³»ç»Ÿæ¶ˆæ¯å¯ä»¥æ¢ä¸ªæ ·å¼ è¦ä¸å ä½äº†
	function RecChat(obj, userName){
		var allMsg = JSON.parse(obj.data);
		var msgType = allMsg.type;
		var msgMessage = allMsg.message;
		var msgTime = allMsg.time;
		var msgName = allMsg.name;
		var msgLvS = allMsg.lvS;
		var msgLvU = allMsg.lvU;

		if(msgName != userName){
			var sTemplate2 = lvSDict[msgLvS];
			var sTemplate3 = msgName;
			var sTemplate5 = msgMessage;
			var template = sTemplate1 + sTemplate2 + sTemplate3 + sTemplate4 + sTemplate5 + sTemplate6
		}else{
			var cTemplate2 = lvSDict[msgLvS];
			var cTemplate3 = msgName;
			var cTemplate5 = msgMessage;
			var template = cTemplate1 + cTemplate2 + cTemplate3 + cTemplate4 + cTemplate5 + cTemplate6
		};
		
		div.innerHTML = div.innerHTML + template;
		div.scrollTop = div.scrollHeight;
	};
	layui.use(['jquery'], function(){
		$ = jQuery = layui.$;
		// æ ¡éªŒå­—æ®µæ˜¯å¦æ­£ç¡®
		function checkt_field(){
			// æ ¡éªŒç”¨æˆ·å
			userName = $("#userName").val();
			if(userName == ""){
				alert("è¯·è¾“å…¥ç”¨æˆ·å");
				return false;
			};	
			// æ ¡éªŒå·²é€‰èŠå¤©å®¤
			if(roomName == ""){
				alert("è¯·é€‰æ‹©èŠå¤©å®¤");
				return false;
			};
			return true;
		};
		// è¿æ¥åˆ·æ–°å…ƒç´ å‡½æ•°
		function connect(){
			// é”å®šæ˜µç§°æ 
			$("#userName").css({
				"cursor": "not-allowed",
				"background": "none",
				});
			// é”å®šèŠå¤©å®¤é€‰æ‹©å™¨
			$("#chooseRoomBtn").css({
				"cursor": "not-allowed",
				"background": "none",
				});
			$(".layui-nav-child").css("visibility", "hidden");
			// æŒ‰é’®å˜æˆæ–­å¼€
			$("#connectBtn").html("æ–­å¼€");
			connection = true;
		};
		// æ–­å¼€åˆ·æ–°å…ƒç´ 
		function disconnect(){
			// é”å®šæ˜µç§°æ 
			$("#userName").css({
				"cursor": "",
				"background": "",
				});
			// é”å®šèŠå¤©å®¤é€‰æ‹©å™¨
			$("#chooseRoomBtn").css({
				"cursor": "",
				"background": "",
				});
			$(".layui-nav-child").css("visibility", "");
			// æŒ‰é’®å˜æˆæ–­å¼€
			$("#connectBtn").html("è¿æ¥");
			connection = false;
		};
		
		// è¿™é‡Œæ˜¯é€‰æ‹©èŠå¤©å®¤
		var roomName = ""
		var userName = ""
		var url = 'ws://120.79.56.46/chat/chat';
		connection = false;
		$("#chooseRoomT").click(function(){
			$("#chooseRoomBtn").text("å¨±ä¹å®¤");
			roomName = "t";
		});
		$("#chooseRoomI").click(function(){
			$("#chooseRoomBtn").text("æ•°ç å®¤");
			roomName = "i";
		});
		$("#chooseRoomE").click(function(){
			$("#chooseRoomBtn").text("ç”µç«å®¤");
			roomName = "e";
		});
		$("#chooseRoomZ").click(function(){
			$("#chooseRoomBtn").text("æ‚è°ˆå®¤");
			roomName = "z";
		});
		// è¿™é‡Œæ˜¯ç‚¹å‡»è¿æ¥æŒ‰é’® è§¦å‘ è¿æ¥ï¼ŒæˆåŠŸåé”å®šæ˜µç§°æ ï¼ŒèŠå¤©å®¤ï¼ŒæŒ‰é’®textè®¾ç½®æˆæ–­å¼€ï¼Œæ–­å¼€æ—¶æ¢å¤
		$("#connectBtn").click(function(){
			// åˆ¤æ–­è¿æ¥çŠ¶æ€
			if ($("#connectBtn").html() == "è¿æ¥"){
				// æ ¡éªŒå­—æ®µ
				if (checkt_field() != true){
					return
				};
				// è¿æ¥websocket
				websocket = new WebSocket(url + "?name=" + userName + "&roomName=" + roomName);
				websocket.onopen = function (evevt) {
					// æˆåŠŸåè§¦å‘å‡½æ•°
					connect();
				};
				// æ¥æ”¶æ¶ˆæ¯
				websocket.onmessage = function (event) {
					RecChat(event, userName);
					};
				// å‘ç”Ÿé”™è¯¯
				websocket.onerror = function (event) {
					// TODO å„ç§æŠ¥é”™é€»è¾‘è¦æ•æ‰
					if(connection == true){
						disconnect();
						alert("è¿æ¥å¤±è´¥äº†ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºå•¥");
					};
				};
				// è¿æ¥å…³é—­
				websocket.onclose = function (event) {
					if(connection == true){
						disconnect();
						alert("ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œè¯·ä¿æŒæ´»è·ƒå“¦~");
					};
				};
			}else{
				// æ–­å¼€
				// æ–­å¼€è¿™é‡Œå¯èƒ½æœ‰å°é—®é¢˜
				websocket.send("\\x03\\xe9");
				disconnect();
			};
		});

	});
</script>
<script>
	//æ³¨æ„ï¼šå¯¼èˆª ä¾èµ– element æ¨¡å—ï¼Œå¦åˆ™æ— æ³•è¿›è¡ŒåŠŸèƒ½æ€§æ“ä½œ
	layui.use('element', function(){
		var element = layui.element;
		element.init();
	});
	// é”®ç›˜äº‹ä»¶
	$("#content").keydown(function(event){
		if(event.ctrlKey && event.keyCode == "13"){
			$("#content").val($("#content").val() + "\n");
		}else if(event.keyCode == "13"){
			$("#sendBtn").click();
		};
	});
	 // æ¸…ç©ºæŒ‰é’®
	$("#clearBtn").click(function(){
		$("#content").val("");
	 });
	 // å‘é€æŒ‰é’®
	$("#sendBtn").click(function(){
		if(connection != true){
			alert("è¯·è¿æ¥åå‘é€")
			return;
		};
		// å‘é€
		if($("#content").val() == ""){
			return
		}else{
			websocket.send(JSON.stringify({"message":$("#content").val()}));
			layedit.clear(editIndex);
		}
	});

</script>
<script type="text/javascript">
	// è¾“å…¥æ¡†+å›¾æ ‡
	$("#personEmoji").emoji({content_el:"#content",
	list:[{
				name:"äººç‰©",
				code:"personEmoji",
			}],
	});
	$("#goodsEmoji").emoji({content_el:"#content",
				list:[{
					name:"ç‰©å“",
					code:"goodsEmoji",
					}],
		});
		$("#flagEmoji").emoji({content_el:"#content",
				list:[{
					name:"æ ‡å¿—",
					code:"flagEmoji",
					}],
			});
		$("#naturalEmoji").emoji({content_el:"#content",
				list:[{
					name:"è‡ªç„¶",
					code:"naturalEmoji",
					}],
			});
		$("#arrowEmoji").emoji({content_el:"#content",
				list:[{
					name:"ç®­å¤´",
					code:"arrowEmoji",
					}],
			});
		$("#animalEmoji").emoji({content_el:"#content",
				list:[{
					name:"åŠ¨ç‰©",
					code:"animalEmoji",
					}],
			});
		$("#sportsEmoji").emoji({content_el:"#content",
				list:[{
					name:"è¿åŠ¨",
					code:"sportsEmoji",
					}],
			});
		$("#foodEmoji").emoji({content_el:"#content",
				list:[{
					name:"é£Ÿç‰©",
					code:"foodEmoji",
					}],
			});
		$("#buildingEmoji").emoji({content_el:"#content",
				list:[{
					name:"å»ºç­‘",
					code:"buildingEmoji",
					}],
			});
		$("#trafficEmoji").emoji({content_el:"#content",
				list:[{
					name:"äº¤é€š",
					code:"trafficEmoji",
					}],
			});
</script>
<script type="text/javascript">
	//é‡æ–°æ¸²æŸ“
	var reRendering = function(){
		// èŠå¤©å®¤å¯¼èˆª #chatTittle
		// èŠå¤©å®¤èƒŒæ™¯ #chatShow
		// èŠå¤©å®¤è¡¨æƒ…æ  #div_emoji #layui-layer-iframe1
		
		$("#chatTittle").css("background-color","#d5c3a6");
		$("#chatShow").css("background-color","#ffeadc");
		$("#div_emoji").css("background-color","#f2debd");
	};
	reRendering();
</script>
</html>