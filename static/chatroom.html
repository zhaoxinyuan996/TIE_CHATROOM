<!DOCTYPE html>
<html lang="zh" style="height: 100%">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title></title>
	<link rel="stylesheet" href="../static/layui/css/layui.css">
	<script src="../static/layui/layui.js"></script>
	<script src="../static/layui/lay/modules/element.js"></script>
	<script src="../static/layui/lay/modules/layedit.js"></script>
	<script src="../static/layui/lay/modules/jquery.js"></script>
</head>
<body style="height: 100%">
	<div class="" style="height: 100%; width: 100%;">
		<div class="" style="height: calc(75% - 30px);">
			<!-- 大框，包括输入昵称，选择聊天室，连接按钮 -->
			<ul class="layui-nav" lay-filter="" style="background-color: #9F9F9F; height: 60px;">
				<li class="layui-nav-item"><input type="text" name="" id="userName" value="你的昵称" /></input></li>
				<li class="layui-nav-item">
					<a href="javascript:;" id="chooseRoomBtn">选择聊天室</a>
					<dl class="layui-nav-child">
						<dd><a id="chooseRoomT">T-娱乐室</a></dd>
						<dd><a id="chooseRoomI">I -数码室</a></dd>
						<dd><a id="chooseRoomE">E-电竞室</a></dd>
						<dd><a id="chooseRoomZ">Z-杂谈室</a></dd>
					</dl>
				</li>
		
				<li class="layui-nav-item"><button type="button" class="layui-btn layui-btn-radius layui-btn-primary" id="connectBtn">连接</button></li>
			</ul>
			<!-- 聊天展示区 -->
			<div id="chatShow" style="background-color: #C2C2C2; height: 100%; overflow-y: auto;">
		
				
			</div>
				
			</div>
			<!-- 聊天键入区 -->
			<div style="background-color: #C2C2C2; height: 25%; overflow:hidden;">
				<textarea id="input" style="width: 100%; height: 100%; resize: none; box-sizing: border-box;">内容</textarea>
			</div>
			<!-- 功能区 -->
			<div style="background-color: #C2C2C2; height: 0%; width: 100%;">
				<button type="button" id="sendBtn" class="layui-btn layui-btn-sm layui-btn-primary" style="float: right;">
				  <i class="layui-icon">&#x1005;</i>发送
				</button>
				<button type="button" id="clearBtn" class="layui-btn layui-btn-sm layui-btn-primary" style="float: right;">
				  <i class="layui-icon">&#x1006;</i>清空
				</button>
		
			</div>
		</div>
	</div>
</body>
<script>
	window.onload = function(){
		var seeWidth = document.body.clientWidth;
		var seeHeight = document.body.clientHeight;
		
		document.body.onkeydown = function (event) {
			if(event.keyCode == "13"){
				return false;
			};
		}
	};
	var lvSDict = {
		0:'<i class="layui-icon" style="color: #FFECEC;">&#xe735;</i>',
		1:'<i class="layui-icon" style="color: #FFD2D2;">&#xe735;</i>',
		2:'<i class="layui-icon" style="color: #FFB5B5;">&#xe735;</i>',
		3:'<i class="layui-icon" style="color: #FF9797;">&#xe735;</i>',
		4:'<i class="layui-icon" style="color: #FF7575;">&#xe735;</i>',
		5:'<i class="layui-icon" style="color: #FF5151;">&#xe735;</i>',
		6:'<i class="layui-icon" style="color: #FF2D2D;">&#xe735;</i>',
		7:'<i class="layui-icon" style="color: #FF0000;">&#xe735;</i>',
		8:'<i class="layui-icon" style="color: #EA0000;">&#xe735;</i>',
		9:'<i class="layui-icon" style="color: #CE0000;">&#xe735;</i>',
		10:'<i class="layui-icon" style="color: #AE0000;">&#xe735;</i>'
	};
	// var LvUDict = {
	// 	0:'<i class="layui-icon" style="color: #FFECEC;">&#xe735;</i>',
	// 	1:'<i class="layui-icon" style="color: #FFD2D2;">&#xe735;</i>',
	// 	2:'<i class="layui-icon" style="color: #FFB5B5;">&#xe735;</i>',
	// 	3:'<i class="layui-icon" style="color: #FF9797;">&#xe735;</i>',
	// 	4:'<i class="layui-icon" style="color: #FF7575;">&#xe735;</i>',
	// 	5:'<i class="layui-icon" style="color: #FF5151;">&#xe735;</i>',
	// 	6:'<i class="layui-icon" style="color: #FF2D2D;">&#xe735;</i>',
	// 	7:'<i class="layui-icon" style="color: #FF0000;">&#xe735;</i>',
	// 	8:'<i class="layui-icon" style="color: #EA0000;">&#xe735;</i>',
	// 	9:'<i class="layui-icon" style="color: #CE0000;">&#xe735;</i>',
	// 	10:'<i class="layui-icon" style="color: #AE0000;">&#xe735;</i>'
	// };

	var div = document.getElementById("chatShow");
	var sTemplate1 = '<div><div><div style="background-color: #26a69a; border-radius:10px; margin: 2px 5px; padding: 8px; display:inline-block; *display:inline; *zoom:1;">'
	// var sTemplate2 = '<i class="layui-icon">&#xe735;</i>'
	// var sTemplate3 = '用户名：'
	var sTemplate4 = '</div></div><div style="background-color: #26a69a; border-radius:10px; margin: 10px 50px; padding: 8px; display:inline-block; *display:inline; *zoom:1;">'
	// var sTemplate5 = '说的话说'
	var sTemplate6 = '</div></div>'
	
	var cTemplate1 = '<div style="overflow:hidden;"><div style="overflow:hidden;"><div style="background-color: #26a69a; border-radius:10px; margin: 2px 5px; padding: 8px; display:inline-block; *display:inline; *zoom:1; float: right;">'
	// var cTemplate2 = '<i class="layui-icon">&#xe735;</i>'
	// var cTemplate3 = '自己：'
	var cTemplate4 = '</div></div><div style="background-color: #26a69a; border-radius:10px; margin: 10px 50px; padding: 8px; display:inline-block; *display:inline; *zoom:1; float: right;">'
	// var cTemplate5 = '自己的话自己的话自'
	var cTemplate6 = '</div></div>'

	// 接收消息类
	// TODO 这里的系统消息可以换个样式 要不占位了
	function RecChat(obj, userName){
		var allMsg = JSON.parse(obj.data);
		var msgType = allMsg.type;
		var msgMessage = allMsg.message;
		var msgTime = allMsg.time;
		var msgName = allMsg.name;
		var msgLvS = allMsg.lvS;
		var msgLvU = allMsg.lvU;

		if(msgName != userName){
			var sTemplate2 = lvSDict[msgLvS];
			var sTemplate3 = msgName;
			var sTemplate5 = msgMessage;
			var template = sTemplate1 + sTemplate2 + sTemplate3 + sTemplate4 + sTemplate5 + sTemplate6
		}else{
			var cTemplate2 = lvSDict[msgLvS];
			var cTemplate3 = msgName;
			var cTemplate5 = msgMessage;
			var template = cTemplate1 + cTemplate2 + cTemplate3 + cTemplate4 + cTemplate5 + cTemplate6
		};
		
		div.innerHTML = div.innerHTML + template;
		div.scrollTop = div.scrollHeight;
	};
	layui.use(['jquery'], function(){
		$ = jQuery = layui.$;
		// 校验字段是否正确
		function checkt_field(){
			// 校验用户名
			userName = $("#userName").val();
			if(userName == ""){
				alert("请输入用户名");
				return false;
			};	
			// 校验已选聊天室
			if(roomName == ""){
				alert("请选择聊天室");
				return false;
			};
			return true;
		};
		// 连接刷新元素函数
		function connect(){
			// 锁定昵称栏
			$("#userName").css({
				"cursor": "not-allowed",
				"background": "none",
				});
			// 锁定聊天室选择器
			$("#chooseRoomBtn").css({
				"cursor": "not-allowed",
				"background": "none",
				});
			$(".layui-nav-child").css("visibility", "hidden");
			// 按钮变成断开
			$("#connectBtn").html("断开");
			connection = true;
		};
		// 断开刷新元素
		function disconnect(){
			// 锁定昵称栏
			$("#userName").css({
				"cursor": "",
				"background": "",
				});
			// 锁定聊天室选择器
			$("#chooseRoomBtn").css({
				"cursor": "",
				"background": "",
				});
			$(".layui-nav-child").css("visibility", "");
			// 按钮变成断开
			$("#connectBtn").html("连接");
			connection = false;
		};
		
		// 这里是选择聊天室
		var roomName = ""
		var userName = ""
		var url = 'ws://120.79.56.46/chat/chat';
		connection = false;
		$("#chooseRoomT").click(function(){
			$("#chooseRoomBtn").text("娱乐室");
			roomName = "t";
		});
		$("#chooseRoomI").click(function(){
			$("#chooseRoomBtn").text("数码室");
			roomName = "i";
		});
		$("#chooseRoomE").click(function(){
			$("#chooseRoomBtn").text("电竞室");
			roomName = "e";
		});
		$("#chooseRoomZ").click(function(){
			$("#chooseRoomBtn").text("杂谈室");
			roomName = "z";
		});
		// 这里是点击连接按钮 触发 连接，成功后锁定昵称栏，聊天室，按钮text设置成断开，断开时恢复
		$("#connectBtn").click(function(){
			// 判断连接状态
			if ($("#connectBtn").html() == "连接"){
				// 校验字段
				if (checkt_field() != true){
					return
				};
				// 连接websocket
				websocket = new WebSocket(url + "?name=" + userName + "&roomName=" + roomName);
				websocket.onopen = function (evevt) {
					// 成功后触发函数
					connect();
				};
				// 接收消息
				websocket.onmessage = function (event) {
					RecChat(event, userName);
					};
				// 发生错误
				websocket.onerror = function (event) {
					// TODO 各种报错逻辑要捕捉
					if(connection == true){
						disconnect();
						alert("连接失败了，我也不知道为啥");
					};
				};
				// 连接关闭
				websocket.onclose = function (event) {
					if(connection == true){
						disconnect();
						alert("与服务器断开连接，请保持活跃哦~");
					};
				};
			}else{
				// 断开
				// 断开这里可能有小问题
				websocket.send("\\x03\\xe9");
				disconnect();
			};
		});

	});
</script>
<script>
	//注意：导航 依赖 element 模块，否则无法进行功能性操作
	layui.use('element', function(){
		var element = layui.element;
		element.init();
	});
	layui.use('layedit', function(){
		var layedit = layui.layedit;
		var editIndex = layedit.build(
		  "input", {
				"tool": [
					'face'	//表情
				],
				"height": "100%"
				}
		);		//建立编辑器
		
		 // 清空按钮
		$("#clearBtn").click(function(){
			// $("#input").val("");
			layedit.clear(editIndex);
		 });
		 // 发送按钮
		$("#sendBtn").click(function(){
			if(connection != true){
				alert("请连接后发送")
				return;
			};
			// 发送
			if(layedit.getText(editIndex) == ""){
				return
			}else{
				websocket.send(JSON.stringify({"message":layedit.getText(editIndex)}));
				layedit.clear(editIndex);
			}
		});
		function setFocus(el) {
		    el = el[0]; // jquery 对象转dom对象  
		    el.focus();
		    var range = document.createRange();
		    range.selectNodeContents(el);
		    range.collapse(false);
		    var sel = window.getSelection();
			sel.removeAllRanges();
			sel.addRange(range);
			console.log($("#LAY_layedit_1")[0].contentWindow.document);
			range.setStart($("#LAY_layedit_1")[0].contentWindow.document, 2);
			console.log(range);
		};
		// 这个给跪了，解决在子iframe中键盘事件监听不到的bug
		$($("#LAY_layedit_1")[0].contentWindow.document).keydown(function(event){
			if(event.ctrlKey && event.keyCode == "13"){
				layedit.newLine(editIndex);
				setFocus($("#LAY_layedit_1"));
				// console.log(layedit.getContent(editIndex));
			}else if(event.keyCode == "13"){
				event.preventDefault();
				$("#sendBtn").click();
			};
			
		});
		
		// enterPress(ff);

	});
</script>
</html>